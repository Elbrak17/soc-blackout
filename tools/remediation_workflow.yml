# SOC Blackout — Remediation Workflow
#
# Purpose: Execute approved remediation actions and log them to the audit trail
# Tool Type: Elastic Workflow (called as a Workflow tool by the agent)
#
# This workflow has two steps:
#   1. Log the action to the soc-actions audit index
#   2. Generate a post-mortem summary via the SOC Blackout agent
#
# ============================================================
# KIBANA SETUP INSTRUCTIONS
# ============================================================
#
# PART A — Create the Workflow:
#   1. Go to Kibana → Management → Workflows
#   2. Create a new workflow, paste the YAML definition below
#   3. Save it
#
# PART B — Create the Workflow Tool:
#   1. Go to Agent Builder → Tools → Create Tool → Workflow
#   2. Tool ID: remediation_workflow
#   3. Name: Remediation Workflow
#   4. Description (copy this exactly):
#        Executes an approved remediation action and logs it to
#        the soc-actions audit trail. Generates a post-mortem
#        summary automatically. ONLY call this tool AFTER the
#        operator has explicitly approved the proposed action.
#        NEVER call this tool autonomously.
#   5. Link to the workflow created in Part A
#
# PART C — Parameters (these are the workflow inputs):
#
#    ┌───────────────┬─────────┬──────────┬──────────────────────────────────────────────────────────┐
#    │ Name          │ Type    │ Required │ Description                                              │
#    ├───────────────┼─────────┼──────────┼──────────────────────────────────────────────────────────┤
#    │ action_type   │ string  │ yes      │ Category of the remediation action being executed.       │
#    │               │         │          │ Examples: "pod_restart", "config_rollback",               │
#    │               │         │          │ "cert_renewal", "scale_up", "hotfix_deploy".              │
#    ├───────────────┼─────────┼──────────┼──────────────────────────────────────────────────────────┤
#    │ description   │ string  │ yes      │ Human-readable description of the exact action taken.    │
#    │               │         │          │ Example: "Restarted payment-service pods on prod-app-01   │
#    │               │         │          │ and prod-app-02 to resolve OOM issue".                    │
#    ├───────────────┼─────────┼──────────┼──────────────────────────────────────────────────────────┤
#    │ confidence    │ integer │ yes      │ The agent's confidence score for this action (0-100).    │
#    │               │         │          │ Must be >= 70 to proceed with execution.                  │
#    ├───────────────┼─────────┼──────────┼──────────────────────────────────────────────────────────┤
#    │ incident_ref  │ string  │ yes      │ Reference to the correlated historical incident.         │
#    │               │         │          │ Example: "INC-001". Use "NONE" if no match was found.     │
#    └───────────────┴─────────┴──────────┴──────────────────────────────────────────────────────────┘
#
# ============================================================

# --- Elastic Workflow Definition (YAML) ---

version: "1"
name: soc_blackout_remediate
description: >
  Execute approved remediation actions for SOC Blackout.
  Logs the action to the soc-actions audit index and generates a post-mortem summary.
enabled: true

triggers:
  - type: manual

steps:
  # Step 1: Log the executed action to the audit trail
  - name: log_action_to_audit
    type: elasticsearch.index
    with:
      index: "soc-actions"
      document:
        "@timestamp": "{{ now }}"
        action_type: "{{ inputs.action_type }}"
        description: "{{ inputs.description }}"
        confidence: "{{ inputs.confidence }}"
        status: "executed"
        incident_ref: "{{ inputs.incident_ref }}"

  # Step 2: Ask the agent to generate a post-mortem summary
  - name: generate_postmortem
    type: ai.agent
    with:
      agent_id: "soc-blackout"
      message: |
        Remediation action has been executed:
        - Action: {{ inputs.action_type }}
        - Description: {{ inputs.description }}
        - Confidence: {{ inputs.confidence }}%
        - Related incident: {{ inputs.incident_ref }}

        Generate a brief post-mortem summary including:
        1. Root cause identified
        2. Action taken
        3. Estimated time saved vs manual resolution (baseline: 45 min average MTTR)
        4. Recommendations to prevent recurrence

  # Step 3: Log the post-mortem result
  - name: log_postmortem
    type: console
    with:
      message: "{{ steps.generate_postmortem.output }}"
